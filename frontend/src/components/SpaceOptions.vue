<template>
  <DropdownMoreOptions
    v-bind="$attrs"
    :options="validOptions.length ? validOptions : emptyOptions"
  />

  <MergeSpaceDialog v-model="showSpaceMergeDialog" :spaceId="props.spaceId" />
  <ChangeSpaceCategoryDialog v-model="showSpaceCategoryDialog" :spaceId="props.spaceId" />
  <EditSpaceDialog v-model="showSpaceEditDialog" :spaceId="props.spaceId" />
  <ManageMembersDialog v-model="inviteGuestDialog" :spaceId="props.spaceId" />
</template>
<script setup lang="ts">
import { computed, ref } from 'vue'
import { useRouter } from 'vue-router'
import { useDoctype } from 'frappe-ui'
import DropdownMoreOptions from './DropdownMoreOptions.vue'
import MergeSpaceDialog from './MergeSpaceDialog.vue'
import ChangeSpaceCategoryDialog from './ChangeSpaceCategoryDialog.vue'
import EditSpaceDialog from './EditSpaceDialog.vue'
import ManageMembersDialog from './ManageMembersDialog.vue'
import { createDialog } from '@/utils/dialogs'
import { unreadCount, useSpace } from '@/data/spaces'
import { usePinnedSpaces } from '@/data/pinnedSpaces'
import { GPProject } from '@/types/doctypes'

import LucideUserPlus from '~icons/lucide/user-plus'
import LucideEdit from '~icons/lucide/edit'
import LucideMerge from '~icons/lucide/merge'
import LucideArchive from '~icons/lucide/archive'
import LucideTrash2 from '~icons/lucide/trash-2'
import LucideLogOut from '~icons/lucide/log-out'
import LucideCheck from '~icons/lucide/check'
import LucideLayoutPanelTop from '~icons/lucide/layout-panel-top'
import LucidePin from '~icons/lucide/pin'
import LucidePinOff from '~icons/lucide/pin-off'

defineOptions({
  inheritAttrs: false,
})

const props = defineProps<{
  spaceId: string
}>()

const router = useRouter()
const space = useSpace(() => props.spaceId)
const spaces = useDoctype<GPProject>('GP Project')
const { isPinned, pinSpace, unpinSpace } = usePinnedSpaces()

const showSpaceMergeDialog = ref(false)
const showSpaceCategoryDialog = ref(false)
const showSpaceEditDialog = ref(false)
const inviteGuestDialog = ref(false)

const options = computed(() => [
  {
    label: isPinned(props.spaceId) ? 'Remove from My Spaces' : 'Add to My Spaces',
    icon: isPinned(props.spaceId) ? LucidePinOff : LucidePin,
    onClick: async () => {
      if (isPinned(props.spaceId)) {
        return unpinSpace(props.spaceId)
      } else {
        return pinSpace(props.spaceId)
      }
    },
    condition: () => !space.value?.archived_at,
  },
  {
    label: 'Edit settings',
    icon: LucideEdit,
    onClick: () => (showSpaceEditDialog.value = true),
    condition: () => !space.value?.archived_at,
  },
  {
    label: 'Customize space',
    icon: LucideLayoutPanelTop,
    onClick: () => {
      router.push({
        name: 'SpaceCustomize',
        params: { spaceId: props.spaceId },
      })
    },
    condition: () => !space.value?.archived_at,
  },
  {
    label: 'Mark all as read',
    icon: LucideCheck,
    onClick: () => {
      createDialog({
        title: 'Are you sure?',
        message:
          'This action will mark all discussions in this space as read. This action cannot be undone.',
        actions: [
          {
            label: 'Mark all as read',
            variant: 'solid',
            onClick: ({ close }) => {
              return spaces.runDocMethod
                .submit({
                  method: 'mark_all_as_read',
                  name: props.spaceId,
                })
                .then(() => {
                  close()
                  unreadCount.reload()
                })
            },
          },
        ],
      })
    },
    condition: () => !space.value?.archived_at,
  },
  {
    label: 'Manage Members',
    icon: LucideUserPlus,
    onClick: () => (inviteGuestDialog.value = true),
    condition: () => !space.value?.archived_at,
  },
  //   {
  //     label: 'Change Category',
  //     icon: LucideLogOut,
  //     onClick: () => (showSpaceCategoryDialog.value = true),
  //     condition: () => !space.value?.archived_at,
  //   },
  {
    label: 'Merge',
    icon: LucideMerge,
    onClick: () => (showSpaceMergeDialog.value = true),
    condition: () => !space.value?.archived_at,
  },
  {
    label: 'Archive',
    icon: LucideArchive,
    onClick: () => {
      createDialog({
        title: 'Archive space',
        message:
          'You cannot create new discussions, pages or tasks in an archived space. It will remain read-only. You can unarchive it again at any time.',
        actions: [
          {
            label: 'Archive',
            variant: 'solid',
            loading: spaces.runDocMethod.loading,
            onClick: ({ close }) => {
              spaces.runDocMethod
                .submit({
                  method: 'archive',
                  name: props.spaceId,
                })
                .then(close)
            },
          },
        ],
      })
    },
    condition: () => !space.value?.archived_at,
  },
  {
    label: 'Unarchive',
    icon: LucideArchive,
    onClick: () => {
      createDialog({
        title: 'Unarchive space',
        message: 'This will unarchive the space and restore its functionality.',
        actions: [
          {
            label: 'Unarchive',
            variant: 'solid',
            loading: spaces.runDocMethod.loading,
            onClick: ({ close }) => {
              spaces.runDocMethod
                .submit({
                  method: 'unarchive',
                  name: props.spaceId,
                })
                .then(close)
            },
          },
        ],
      })
    },
    condition: () => space.value?.archived_at,
  },
  {
    label: 'Delete',
    icon: LucideTrash2,
    onClick: () => {
      let message = `This will permanently delete the space and all its content. This action cannot be undone.`
      if (space.value?.discussions_count && space.value?.tasks_count) {
        message = `This will permanently delete the space and all its content. This space has ${space.value?.discussions_count} discussions and ${space.value?.tasks_count} tasks. This action cannot be undone.`
      } else if (space.value?.discussions_count) {
        message = `This will permanently delete the space and all its content. This space has ${space.value?.discussions_count} discussions. This action cannot be undone.`
      }
      createDialog({
        title: 'Delete space',
        message,
        actions: [
          {
            label: 'Delete',
            theme: 'red',
            variant: 'solid',
            loading: spaces.delete.loading,
            onClick: ({ close }) => spaces.delete.submit({ name: props.spaceId }).then(close),
          },
        ],
      })
    },
    condition: () => !space.value?.archived_at,
  },
])

const emptyOptions = [
  {
    label: 'No actions',
    disabled: true,
  },
]

const validOptions = computed(() => options.value.filter((option) => option.condition()))
</script>
